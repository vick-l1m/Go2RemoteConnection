<!-- go2_joystick.html -->

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Go2 Teleop</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 14px; }
    .card { max-width: 760px; margin: 0 auto; border: 1px solid #ddd; border-radius: 16px; padding: 14px; }
    h1 { margin: 0 0 10px; font-size: 20px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    input { padding: 10px; border-radius: 12px; border: 1px solid #ccc; flex: 1; min-width: 220px; font-size: 16px; }
    button {
      padding: 12px 12px; border-radius: 12px; border: 1px solid #ccc; background: #f7f7f7;
      font-size: 16px; cursor: pointer; min-width: 120px;
    }
    .danger { background: #fff1f1; border-color: #ffb3b3; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
    .joyBox { border: 1px solid #eee; border-radius: 16px; padding: 10px; background: #fafafa; }
    .joyTitle { font-size: 14px; color: #333; margin: 0 0 8px; }
    canvas { width: 100%; height: 280px; border-radius: 14px; background: #fff; border: 1px solid #eee; touch-action: none; }
    .status { margin-top: 10px; padding: 10px; border-radius: 12px; background: #fafafa; border: 1px solid #eee; }
    .small { font-size: 13px; color: #555; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; white-space: pre-wrap; }
    .hint { margin-top: 6px; }
    
    .termPanel { margin-top: 12px; border: 1px solid #eee; border-radius: 16px; background: #0f0f0f; overflow: hidden; }
    .termHeader { display:flex; justify-content: space-between; align-items:center; padding: 10px 12px; background:#171717; border-bottom:1px solid #2a2a2a; }
    .termTitle { color:#fff; font-size:14px; font-weight:600; }
    .termHint { color:#bbb; }
    .termBox { width: 100%; height: 320px; }

  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css" />
  <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
</head>

<body>
  <div class="card">
    <h1>Unitree Go2 – Phone Teleop</h1>

    <div class="row">
      <input id="baseUrl" placeholder="http://<go2-ip>:8000" />
      <button onclick="checkHealth()">Health</button>
      <button onclick="postAction('stand')">Stand</button>
      <button onclick="postAction('sit')">Sit</button>
      <button class="danger" onclick="emergencyStop()">STOP</button>
      <button onclick="toggleTerminal()">Terminal</button>
    </div>

    <div class="small hint">
      UI host: <span id="uiHost" class="mono"></span><br/>
      API base: <span id="apiHost" class="mono"></span>
    </div>

    <div class="grid">
      <div class="joyBox">
        <div class="joyTitle">Left joystick: X=fwd/back, Y=strafe</div>
        <canvas id="joyLeft"></canvas>
      </div>
      <div class="joyBox">
        <div class="joyTitle">Right joystick: X=turn (yaw). Y unused.</div>
        <canvas id="joyRight"></canvas>
      </div>
    </div>

    <div id="terminalPanel" class="termPanel" style="display:none;">
      <div class="termHeader">
        <div class="termTitle">Remote Terminal</div>
        <div class="termHint small">Tip: terminal connects to API (:8000)</div>
      </div>
      <div id="terminal" class="termBox"></div>
    </div>
    
    <div class="status">
      <div id="msg" class="small">Ready.</div>
      <div id="detail" class="mono"></div>
    </div>

    <div class="small" style="margin-top:10px;">
      Tip: keep a finger on the joysticks; releasing them sends a zero command.
    </div>
  </div>

  <script>
    // ----------------------------
    // Terminal (xterm.js) with toggle + resize
    // ----------------------------
    let term = null;
    let ws = null;
    let termOpen = false;
    let resizeObserver = null;

    function apiWsBase() {
      // Use the API base input if provided, otherwise default to hostname:8000
      const api = baseUrl(); // e.g. http://192.168.x.x:8000
      const u = new URL(api);
      const wsProto = u.protocol === "https:" ? "wss" : "ws";
      return `${wsProto}://${u.host}`; // includes port
    }


    function ensureTerminalStarted() {
      if (term) return;

      term = new Terminal({
        cursorBlink: true,
        fontSize: 14,
        convertEol: true,
        theme: { background: "#0f0f0f" }
      });

      const container = document.getElementById("terminal");
      term.open(container);

      // Connect websocket to backend terminal endpoint
      ws = new WebSocket(`${apiWsBase()}/ws/terminal`);

      ws.onopen = () => {
        term.write("\r\n[Connected to Go2 terminal]\r\n");
        // send initial size
        sendTermResize();
      };

      ws.onmessage = (e) => term.write(e.data);
      ws.onclose = () => term.write("\r\n[Terminal disconnected]\r\n");
      ws.onerror = () => term.write("\r\n[Terminal error]\r\n");

      term.onData(data => {
        if (ws && ws.readyState === WebSocket.OPEN) ws.send(data);
      });

      // Observe container size and notify backend
      resizeObserver = new ResizeObserver(() => {
        // Debounce a little (resize fires a lot)
        window.clearTimeout(window.__termResizeT);
        window.__termResizeT = window.setTimeout(sendTermResize, 100);
      });
      resizeObserver.observe(container);
    }

    function toggleTerminal() {
      const panel = document.getElementById("terminalPanel");
      termOpen = !termOpen;
      panel.style.display = termOpen ? "block" : "none";

      if (termOpen) {
        ensureTerminalStarted();
        // xterm needs a moment after becoming visible
        setTimeout(() => {
          term.refresh(0, term.rows - 1);
          sendTermResize();
          term.focus();
        }, 50);
      }
    }

    function sendTermResize() {
      if (!term || !ws || ws.readyState !== WebSocket.OPEN) return;

      // Compute cols/rows from pixel size and renderer measurements.
      // xterm doesn't know exact cell size without an addon; use its internal render dimensions if present.
      const container = document.getElementById("terminal");
      const w = container.clientWidth;
      const h = container.clientHeight;

      // Reasonable fallback cell sizes (in px)
      const cellW = 9;
      const cellH = 18;

      const cols = Math.max(20, Math.floor(w / cellW));
      const rows = Math.max(5, Math.floor(h / cellH));

      const msg = JSON.stringify({ resize: { cols, rows } });
      ws.send(msg);
    }
  </script>
<script>

  // ----------------------------
  // Auto-config (IMPORTANT)
  // ----------------------------
  window.addEventListener("DOMContentLoaded", () => {
    // Page is served from http://<host>:8081/...
    // API is FastAPI on http://<host>:8000
    const host = location.hostname; // hostname only (no port)
    const defaultApi = `http://${host}:8000`;

    const base = document.getElementById("baseUrl");
    if (!base.value || base.value.trim() === "" || base.value.includes("192.168.123.18")) {
      base.value = defaultApi;
    }

    document.getElementById("uiHost").textContent = location.origin;
    document.getElementById("apiHost").textContent = base.value;
  });

  // ----------------------------
  // Networking helpers
  // ----------------------------
  function baseUrl() {
    return document.getElementById("baseUrl").value.trim().replace(/\/+$/, "");
  }

  function setStatus(text, ok=true, detail="") {
    const msg = document.getElementById("msg");
    const detailEl = document.getElementById("detail");
    msg.textContent = text;
    msg.style.color = ok ? "#0a7a0a" : "#b00020";
    detailEl.textContent = detail || "";
    // update hint
    const apiHost = document.getElementById("apiHost");
    if (apiHost) apiHost.textContent = baseUrl();
  }

  async function httpGet(path) {
    const url = baseUrl() + path;
    const r = await fetch(url, { method: "GET" });
    const t = await r.text();
    return { ok: r.ok, status: r.status, text: t, url };
  }

  async function httpPost(path, json=null) {
    const url = baseUrl() + path;
    const r = await fetch(url, {
      method: "POST",
      headers: json ? { "Content-Type": "application/json" } : {},
      body: json ? JSON.stringify(json) : null
    });
    const t = await r.text();
    return { ok: r.ok, status: r.status, text: t, url };
  }

  async function checkHealth() {
    setStatus("Checking /health...");
    try {
      const r = await httpGet("/health");
      setStatus(
        r.ok ? "Health OK ✅" : `Health failed (HTTP ${r.status})`,
        r.ok,
        `URL: ${r.url}\n${r.text}`
      );
    } catch (e) {
      setStatus(
        "Health network error",
        false,
        `API base was: ${baseUrl()}\n` + String(e) +
        "\n\nTip: API must be http://<go2-ip>:8000 (NOT :8081)."
      );
    }
  }

  async function postAction(action) {
    setStatus(`Sending ${action}...`);
    try {
      const r = await httpPost(`/actions/${action}`);
      setStatus(
        r.ok ? `${action} started ✅` : `${action} failed (HTTP ${r.status})`,
        r.ok,
        `URL: ${r.url}\n${r.text}`
      );
    } catch (e) {
      setStatus(
        `${action} network error`,
        false,
        `API base was: ${baseUrl()}\n` + String(e) +
        "\n\nTip: API must be http://<go2-ip>:8000 (NOT :8081)."
      );
    }
  }

  async function emergencyStop() {
    await sendTeleop(0, 0, 0);
    await httpPost(`/actions/stop`).catch(()=>{});
    setStatus("STOP sent ✅", true);
  }

  // ----------------------------
  // Teleop send loop (rate-limited)
  // ----------------------------
  let latest = { lx: 0, ly: 0, rx: 0, ry: 0 };
  let sending = false;
  let lastSendMs = 0;

  // Tuning (safe defaults)
  const MAX_LIN = 0.6;   // m/s
  const MAX_ANG = 1.2;   // rad/s
  const SEND_HZ = 10;    // send rate
  const SEND_PERIOD_MS = Math.floor(1000 / SEND_HZ);

  function mapToCmd(lx, ly, rx) {
    // Joystick y is positive down; invert so up = forward
    const linear_x = (-ly) * MAX_LIN;
    const linear_y = (lx) * MAX_LIN;     // strafe
    const angular_z = (rx) * MAX_ANG;    // turn
    return { linear_x, linear_y, angular_z };
  }

  async function sendTeleop(lx, ly, rx) {
    const cmd = mapToCmd(lx, ly, rx);
    try {
      const r = await httpPost("/teleop", cmd);
      if (!r.ok) {
        setStatus(
          `Teleop failed (HTTP ${r.status})`,
          false,
          `URL: ${r.url}\n${r.text}\n\nIf you see HTTP 501, you're hitting :8081 not :8000.`
        );
      } else {
        setStatus(
          `Teleop: vx=${cmd.linear_x.toFixed(2)} vy=${cmd.linear_y.toFixed(2)} wz=${cmd.angular_z.toFixed(2)}`,
          true
        );
      }
    } catch (e) {
      setStatus(
        "Teleop network error",
        false,
        `API base was: ${baseUrl()}\n` + String(e) +
        "\n\nTip: API must be http://<go2-ip>:8000 (NOT :8081)."
      );
    }
  }

  function scheduleSend() {
    if (sending) return;
    sending = true;

    const tick = async () => {
      const now = Date.now();
      if (now - lastSendMs >= SEND_PERIOD_MS) {
        lastSendMs = now;
        await sendTeleop(latest.lx, latest.ly, latest.rx);
      }
      // Keep sending while any stick is active (non-zero)
      if (Math.abs(latest.lx) > 0.01 || Math.abs(latest.ly) > 0.01 || Math.abs(latest.rx) > 0.01) {
        requestAnimationFrame(tick);
      } else {
        sending = false;
      }
    };

    requestAnimationFrame(tick);
  }

  // ----------------------------
  // Joystick implementation (canvas)
  // ----------------------------
  function makeJoystick(canvasId, onMove) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext("2d");

    function resize() {
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.floor(rect.width * devicePixelRatio);
      canvas.height = Math.floor(rect.height * devicePixelRatio);
      draw(0, 0, false);
    }

    let active = false;

    function draw(nx, ny, isActive) {
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0, 0, w, h);

      const centerX = w / 2;
      const centerY = h / 2;
      const radius = Math.min(w, h) * 0.35;
      const knobR = Math.min(w, h) * 0.08;

      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
      ctx.strokeStyle = "#ddd";
      ctx.lineWidth = 4 * devicePixelRatio;
      ctx.stroke();

      ctx.beginPath();
      ctx.moveTo(centerX - radius, centerY);
      ctx.lineTo(centerX + radius, centerY);
      ctx.moveTo(centerX, centerY - radius);
      ctx.lineTo(centerX, centerY + radius);
      ctx.strokeStyle = "#eee";
      ctx.lineWidth = 2 * devicePixelRatio;
      ctx.stroke();

      const kx = centerX + nx * radius;
      const ky = centerY + ny * radius;

      ctx.beginPath();
      ctx.arc(kx, ky, knobR, 0, Math.PI * 2);
      ctx.fillStyle = isActive ? "#e9f2ff" : "#f5f5f5";
      ctx.strokeStyle = "#bbb";
      ctx.lineWidth = 3 * devicePixelRatio;
      ctx.fill();
      ctx.stroke();
    }

    function pointerToNorm(e) {
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width;
      const y = (e.clientY - rect.top) / rect.height;

      let nx = (x - 0.5) * 2;
      let ny = (y - 0.5) * 2;

      const mag = Math.hypot(nx, ny);
      if (mag > 1) { nx /= mag; ny /= mag; }

      return { nx, ny };
    }

    canvas.addEventListener("pointerdown", (e) => {
      canvas.setPointerCapture(e.pointerId);
      active = true;
      const { nx, ny } = pointerToNorm(e);
      draw(nx, ny, true);
      onMove(nx, ny, true);
    });

    canvas.addEventListener("pointermove", (e) => {
      if (!active) return;
      const { nx, ny } = pointerToNorm(e);
      draw(nx, ny, true);
      onMove(nx, ny, true);
    });

    function release(e) {
      if (!active) return;
      active = false;
      draw(0, 0, false);
      onMove(0, 0, false);
    }

    canvas.addEventListener("pointerup", release);
    canvas.addEventListener("pointercancel", release);
    window.addEventListener("resize", resize);

    resize();
  }

  // Wire joysticks into teleop stream
  makeJoystick("joyLeft", (x, y, active) => {
    latest.lx = active ? x : 0;
    latest.ly = active ? y : 0;
    scheduleSend();
  });

  makeJoystick("joyRight", (x, y, active) => {
    latest.rx = active ? x : 0;
    latest.ry = active ? y : 0;
    scheduleSend();
  });
</script>
</body>
</html>
